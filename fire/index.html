<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Fire Incident Log</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700&family=Share+Tech+Mono&family=Barlow+Condensed:wght@400;500;600;700&display=swap');

  :root {
    --red: #CC0000;
    --red-light: #ff2400;
    --red-bg: #fff0f0;
    --amber: #B8860B;
    --amber-bg: #fffbe6;
    --blue: #1F3864;
    --blue-mid: #2E5496;
    --blue-light: #4472C4;
    --border: #cccccc;
    --border-dark: #aaaaaa;
    --bg-gray: #D9D9D9;
    --bg-section: #f5f5f5;
    --text: #111111;
    --text-light: #555555;
    --green: #1a6b1a;
    --stamp-fill: #FFFFCC;
  }

  * { margin:0; padding:0; box-sizing:border-box; }
  body { background:#ddd; font-family:'Barlow Condensed',sans-serif; color:var(--text); font-size:14px; }

  .page { max-width:1100px; margin:20px auto; background:white; box-shadow:0 2px 14px rgba(0,0,0,0.2); border:1px solid #aaa; }

  /* TOP HEADER */
  .top-bar { background:var(--blue); color:white; display:flex; align-items:center; justify-content:space-between; padding:10px 20px; border-bottom:3px solid var(--red); }
  .top-left { display:flex; align-items:center; gap:14px; }
  .flame { font-size:2rem; }
  .top-title { font-family:'Rajdhani',sans-serif; font-size:1.6rem; font-weight:700; letter-spacing:0.1em; text-transform:uppercase; line-height:1; }
  .top-title span { color:#FFB300; }
  .live-wrap { text-align:right; }
  .live-clock { font-family:'Share Tech Mono',monospace; font-size:1.7rem; color:#FFB300; line-height:1; }
  .live-date  { font-family:'Share Tech Mono',monospace; font-size:0.62rem; color:rgba(255,255,255,0.45); letter-spacing:0.15em; margin-top:2px; }

  /* SECTION / SUB HEADERS */
  .sec-hdr { background:var(--blue-mid); color:white; font-family:'Rajdhani',sans-serif; font-size:0.75rem; font-weight:700; letter-spacing:0.25em; text-transform:uppercase; padding:5px 14px; }
  .sub-hdr { background:var(--blue-light); color:white; font-family:'Rajdhani',sans-serif; font-size:0.7rem; font-weight:700; letter-spacing:0.2em; text-transform:uppercase; padding:4px 14px; }

  /* INCIDENT INFO - 4 columns */
  .inc-grid { display:grid; grid-template-columns:1fr 1fr 1fr 1fr; border-bottom:1px solid var(--border); }
  .inc-field { padding:10px 14px; border-right:1px solid var(--border); }
  .inc-field:last-child { border-right:none; }
  .inc-label { font-family:'Share Tech Mono',monospace; font-size:0.58rem; color:#888; letter-spacing:0.2em; text-transform:uppercase; margin-bottom:5px; }
  .inc-input { width:100%; border:1px solid var(--border); background:white; color:var(--text); font-family:'Barlow Condensed',sans-serif; font-size:1rem; font-weight:600; padding:5px 8px; outline:none; transition:border-color 0.2s; }
  .inc-input:focus { border-color:var(--blue-light); box-shadow:0 0 0 2px rgba(68,114,196,0.15); }

  /* ALARM + DISPATCH + DATE/SHIFT/STATION row */
  .time-grid { display:grid; grid-template-columns:1fr 1fr 1fr 1fr; border-bottom:2px solid var(--border-dark); }
  .time-field { padding:8px 14px; border-right:1px solid var(--border); }
  .time-field:last-child { border-right:none; }
  .time-row { display:flex; gap:6px; align-items:center; }
  .time-display { flex:1; font-family:'Share Tech Mono',monospace; font-size:1.05rem; font-weight:700; color:var(--amber); background:var(--amber-bg); border:1px solid #e0d080; padding:5px 8px; text-align:center; letter-spacing:0.05em; }
  .btn-settime { background:var(--red); color:white; border:none; font-family:'Rajdhani',sans-serif; font-size:0.7rem; font-weight:700; letter-spacing:0.1em; padding:6px 10px; cursor:pointer; text-transform:uppercase; white-space:nowrap; }
  .btn-settime:hover { background:var(--red-light); }

  /* UNIT TABLES */
  .units-section { border-bottom:1px solid var(--border-dark); }
  .unit-grid { display:grid; grid-template-columns:repeat(4,1fr); }
  .unit-col { border-right:1px solid var(--border); }
  .unit-col:last-child { border-right:none; }
  .unit-id-row { background:var(--bg-gray); border-bottom:1px solid var(--border-dark); display:flex; align-items:center; }
  .unit-id-label { font-family:'Rajdhani',sans-serif; font-size:1rem; font-weight:700; color:var(--blue); padding:6px 10px; letter-spacing:0.05em; text-transform:uppercase; white-space:nowrap; }
  .status-row { display:flex; align-items:center; border-bottom:1px solid #eee; min-height:26px; }
  .status-row:last-child { border-bottom:none; }
  .status-lbl { flex:1; font-size:0.85rem; color:var(--text-light); padding:3px 10px; font-weight:500; }
  .stamp-btn { font-family:'Share Tech Mono',monospace; font-size:0.72rem; color:var(--red); padding:4px 8px; cursor:pointer; background:none; border:none; border-left:1px solid #eee; min-width:72px; text-align:center; transition:background 0.15s; }
  .stamp-btn:hover { background:var(--red-bg); }
  .stamp-btn.stamped { color:var(--blue); background:var(--stamp-fill); font-weight:700; }
  .stamp-btn.stamped:hover { background:#fffaaa; }

  /* NURSE / NOTIF ‚Äî 4-col: Amb1 | Amb2 | Nurse | Notifications */
  .amb-nurse-grid { display:grid; grid-template-columns:1fr 1fr 1fr 1fr; }
  .notif-hdr { background:var(--bg-gray); border-bottom:1px solid var(--border-dark); font-family:'Rajdhani',sans-serif; font-size:0.8rem; font-weight:700; color:var(--blue); padding:7px 10px; letter-spacing:0.1em; text-transform:uppercase; text-align:center; }

  /* META BAR */
  .meta-bar { background:var(--bg-section); border-top:2px solid var(--border-dark); border-bottom:1px solid var(--border); display:grid; grid-template-columns:1fr 1fr 1fr 1fr; }
  .meta-field { display:flex; align-items:center; padding:7px 14px; border-right:1px solid var(--border); gap:8px; }
  .meta-field:last-child { border-right:none; }
  .meta-lbl { font-family:'Rajdhani',sans-serif; font-size:0.8rem; font-weight:700; color:var(--blue); letter-spacing:0.1em; white-space:nowrap; }
  .meta-input { flex:1; border:1px solid var(--border); background:white; color:var(--text); font-family:'Barlow Condensed',sans-serif; font-size:0.95rem; font-weight:600; padding:3px 6px; outline:none; }
  .meta-input:focus { border-color:var(--blue-light); }
  .elapsed-disp { font-family:'Share Tech Mono',monospace; font-size:0.95rem; color:var(--amber); font-weight:700; background:var(--amber-bg); border:1px solid #e0d080; flex:1; text-align:center; padding:3px 6px; }

  /* LOG TABLE */
  .log-section { border-bottom:2px solid var(--border-dark); }
  .log-col-hdrs { display:grid; grid-template-columns:110px 1fr 60px; background:var(--bg-gray); border-bottom:2px solid var(--border-dark); }
  .log-col-h { font-family:'Rajdhani',sans-serif; font-size:0.75rem; font-weight:700; color:var(--blue); letter-spacing:0.15em; text-transform:uppercase; padding:6px 12px; border-right:1px solid var(--border); }
  .log-col-h:last-child { border-right:none; }

  .entry-row { display:grid; grid-template-columns:110px 1fr 60px; border-bottom:2px solid var(--red); background:#fffafa; }
  .etime-cell { padding:6px 8px; border-right:1px solid var(--border); display:flex; flex-direction:column; align-items:center; justify-content:center; gap:4px; }
  .etime-disp { font-family:'Share Tech Mono',monospace; font-size:0.85rem; color:var(--amber); font-weight:700; }
  .btn-now { background:var(--red); color:white; border:none; font-family:'Rajdhani',sans-serif; font-size:0.7rem; font-weight:700; letter-spacing:0.1em; padding:3px 8px; cursor:pointer; text-transform:uppercase; width:100%; }
  .btn-now:hover { background:var(--red-light); }
  .etext-cell { padding:4px 8px; border-right:1px solid var(--border); display:flex; align-items:center; }
  .etext-input { width:100%; border:1px solid var(--border); background:white; color:var(--text); font-family:'Barlow Condensed',sans-serif; font-size:0.95rem; font-weight:500; padding:6px 8px; outline:none; height:34px; }
  .etext-input:focus { border-color:var(--red); }
  .eact-cell { padding:5px 6px; display:flex; flex-direction:column; gap:4px; justify-content:center; align-items:center; }
  .btn-log { background:var(--blue); color:white; border:none; font-family:'Rajdhani',sans-serif; font-size:0.7rem; font-weight:700; letter-spacing:0.08em; padding:5px 8px; cursor:pointer; text-transform:uppercase; transition:background 0.15s; width:100%; text-align:center; }
  .btn-log:hover { background:var(--blue-mid); }
  .hotkey { font-family:'Share Tech Mono',monospace; font-size:0.52rem; color:#bbb; text-align:center; }

  /* LOG ROWS ‚Äî editable remarks */
  .log-row { display:grid; grid-template-columns:110px 1fr 60px; border-bottom:1px solid #eee; animation:rowin 0.25s ease-out; }
  .log-row.auto-stamp { background:#f0f4ff; }
  .log-row.auto-stamp:hover { background:#e8eeff; }
  .log-row.auto-stamp .log-time { color: var(--blue-mid); }
  .log-row.auto-stamp .log-remark-input { color: var(--blue-mid); font-weight:700; font-size:0.9rem; }
  @keyframes rowin { from{background:#fff8e1;} to{background:white;} }
  .log-row:hover { background:#f9f9ff; }
  .log-time { font-family:'Share Tech Mono',monospace; font-size:0.85rem; color:var(--blue); padding:6px 12px; border-right:1px solid #eee; font-weight:700; display:flex; align-items:center; white-space:nowrap; }
  .log-remark-input {
    width:100%; border:none; background:transparent; color:var(--text);
    font-family:'Barlow Condensed',sans-serif; font-size:0.9rem; font-weight:500;
    padding:6px 12px; outline:none; resize:none; min-height:32px; height:32px;
    border-right:1px solid #eee; font-size:0.95rem;
    transition: background 0.15s;
  }
  .log-remark-input:focus { background:#f0f4ff; }
  .log-acts { padding:4px 6px; display:flex; align-items:center; justify-content:center; }
  .btn-del { background:none; border:1px solid #ddd; color:#bbb; width:26px; height:26px; cursor:pointer; font-size:0.7rem; transition:all 0.15s; display:flex; align-items:center; justify-content:center; }
  .btn-del:hover { border-color:var(--red); color:var(--red); background:var(--red-bg); }
  .log-empty { padding:40px; text-align:center; font-family:'Share Tech Mono',monospace; font-size:0.72rem; color:#bbb; letter-spacing:0.15em; }

  /* FOOTER */
  .footer { background:var(--bg-section); border-top:1px solid var(--border); display:flex; align-items:center; justify-content:space-between; padding:10px 16px; gap:12px; }
  .footer-stats { font-family:'Share Tech Mono',monospace; font-size:0.68rem; color:#888; letter-spacing:0.08em; }
  .footer-stats b { color:var(--blue); }
  .footer-btns { display:flex; gap:8px; }
  .btn-clear { background:white; border:1px solid var(--border-dark); color:var(--text-light); font-family:'Rajdhani',sans-serif; font-size:0.85rem; font-weight:700; letter-spacing:0.1em; padding:7px 16px; cursor:pointer; text-transform:uppercase; transition:all 0.15s; }
  .btn-clear:hover { border-color:var(--red); color:var(--red); }
  .btn-export { background:var(--green); color:white; border:1px solid #155015; font-family:'Rajdhani',sans-serif; font-size:0.9rem; font-weight:700; letter-spacing:0.12em; padding:8px 22px; cursor:pointer; text-transform:uppercase; transition:all 0.15s; }
  .btn-export:hover { background:#207020; box-shadow:0 2px 8px rgba(0,100,0,0.25); }

  /* TOAST */
  .toast { position:fixed; bottom:22px; right:22px; background:var(--blue); color:white; font-family:'Share Tech Mono',monospace; font-size:0.76rem; letter-spacing:0.08em; padding:11px 17px; z-index:999; opacity:0; transform:translateY(10px); transition:all 0.25s; pointer-events:none; box-shadow:0 4px 16px rgba(0,0,0,0.2); border-left:4px solid #FFB300; }
  .toast.show { opacity:1; transform:translateY(0); }
  .toast.warn { border-left-color:var(--red); background:#7a1010; }

  @media print {
    body { background:white; }
    .page { box-shadow:none; margin:0; }
    .entry-row,.footer,.btn-del,.btn-now,.btn-log { display:none!important; }
  }

  /* ‚îÄ‚îÄ MOBILE ‚îÄ‚îÄ */
  @media (max-width: 700px) {
    body { font-size:13px; }
    .page { margin:0; border:none; box-shadow:none; }

    .top-title { font-size:1.2rem; }
    .live-clock { font-size:1.3rem; }

    /* Stack incident info 2-col on mobile */
    .inc-grid { grid-template-columns:1fr 1fr; }
    .inc-field:nth-child(2n) { border-right:none; }

    /* Stack time grid 2-col */
    .time-grid { grid-template-columns:1fr 1fr; }
    .time-field:nth-child(2n) { border-right:none; }
    .time-field:nth-child(n+3) { border-top:1px solid var(--border); }

    /* Unit grids: 2-col on mobile */
    .unit-grid { grid-template-columns:1fr 1fr; }
    .unit-col:nth-child(2n) { border-right:none; }
    .unit-col:nth-child(n+3) { border-top:1px solid var(--border); }

    /* Amb/Nurse grid: 2-col */
    .amb-nurse-grid { grid-template-columns:1fr 1fr; }
    .amb-nurse-grid .unit-col:nth-child(2n) { border-right:none; }
    .amb-nurse-grid .unit-col:nth-child(n+3) { border-top:1px solid var(--border); }

    /* Meta bar: 2-col */
    .meta-bar { grid-template-columns:1fr 1fr; }
    .meta-field:nth-child(2n) { border-right:none; }
    .meta-field:nth-child(n+3) { border-top:1px solid var(--border); }

    /* Log entry row stacked */
    .entry-row { grid-template-columns:90px 1fr 50px; }
    .log-col-hdrs { grid-template-columns:90px 1fr 50px; }
    .log-row { grid-template-columns:90px 1fr 50px; }

    /* Footer stacks */
    .footer { flex-direction:column; align-items:stretch; gap:8px; }
    .footer-btns { flex-direction:column; }
    .btn-export, .btn-clear { width:100%; padding:12px; font-size:1rem; }

    /* Bigger tap targets for stamp buttons */
    .stamp-btn { min-width:64px; padding:6px 4px; font-size:0.68rem; }
    .btn-settime { padding:8px 10px; }
    .btn-now { padding:5px; }
    .btn-log { padding:8px; }
  }
</style>
</head>
<body>
<div class="page">

  <!-- TOP BAR -->
  <div class="top-bar">
    <div class="top-left">
      <div class="flame">üî•</div>
      <div>
        <div class="top-title">INCIDENT <span>LOG</span></div>
      </div>
    </div>
    <div class="live-wrap">
      <div class="live-clock" id="liveClock">--:--:--</div>
      <div class="live-date"  id="liveDate">---</div>
    </div>
  </div>

  <!-- INCIDENT INFO: 3 fields only -->
  <div class="sec-hdr">‚ñ∂ INCIDENT INFORMATION</div>
  <div class="inc-grid">
    <div class="inc-field">
      <div class="inc-label">Incident Number</div>
      <input class="inc-input" id="incidentNum" placeholder="2026-">
    </div>
    <div class="inc-field">
      <div class="inc-label">Incident Location</div>
      <input class="inc-input" id="incidentLoc" placeholder="Address / Location">
    </div>
    <div class="inc-field">
      <div class="inc-label">Type of Incident</div>
      <input class="inc-input" id="incidentType" placeholder="e.g. Structure Fire, EMS...">
    </div>
    <div class="inc-field">
      <div class="inc-label">ARO (Alarm Room Operator)</div>
      <input class="inc-input" id="aroName" placeholder="ARO Name">
    </div>
  </div>

  <!-- ALARM + DISPATCH + DATE + SHIFT/STATION -->
  <div class="time-grid">
    <div class="time-field">
      <div class="inc-label">Alarm Time</div>
      <div class="time-row">
        <div class="time-display" id="alarmDisp">--:--:--</div>
        <button class="btn-settime" onclick="setTime('alarm')">‚è± SET</button>
      </div>
    </div>
    <div class="time-field">
      <div class="inc-label">Dispatch Time</div>
      <div class="time-row">
        <div class="time-display" id="dispatchDisp">--:--:--</div>
        <button class="btn-settime" onclick="setTime('dispatch')">‚è± SET</button>
      </div>
    </div>
    <div class="time-field">
      <div class="inc-label">Date</div>
      <input class="inc-input" id="metaDate" placeholder="MM/DD/YYYY">
    </div>
    <div class="time-field">
      <div class="inc-label">Shift &amp; Station</div>
      <div style="display:flex;gap:6px;">
        <input class="inc-input" id="metaShift" placeholder="Shift" style="width:80px">
        <input class="inc-input" id="metaStation" placeholder="Station #">
      </div>
    </div>
  </div>

  <!-- UNIT STATUS -->
  <div class="sec-hdr">‚ñ∂ UNIT STATUS</div>

  <!-- Engines / Trucks / Battalion: E1, E2, E3, E4 -->
  <div class="units-section">
    <div class="sub-hdr">Engines / Trucks / Battalion</div>
    <div class="unit-grid">
      <div class="unit-col">
        <div class="unit-id-row"><span class="unit-id-label">E1</span></div>
        <div class="status-row"><span class="status-lbl">Enroute</span>   <button class="stamp-btn" data-unit="E1"  data-status="Enroute"   onclick="stamp(this)">STAMP</button></div>
        <div class="status-row"><span class="status-lbl">Arrived</span>   <button class="stamp-btn" data-unit="E1"  data-status="Arrived"   onclick="stamp(this)">STAMP</button></div>
        <div class="status-row"><span class="status-lbl">In Service</span><button class="stamp-btn" data-unit="E1"  data-status="InService" onclick="stamp(this)">STAMP</button></div>
        <div class="status-row"><span class="status-lbl">In Station</span><button class="stamp-btn" data-unit="E1"  data-status="InStation" onclick="stamp(this)">STAMP</button></div>
      </div>
      <div class="unit-col">
        <div class="unit-id-row"><span class="unit-id-label">E2</span></div>
        <div class="status-row"><span class="status-lbl">Enroute</span>   <button class="stamp-btn" data-unit="E2" data-status="Enroute"   onclick="stamp(this)">STAMP</button></div>
        <div class="status-row"><span class="status-lbl">Arrived</span>   <button class="stamp-btn" data-unit="E2" data-status="Arrived"   onclick="stamp(this)">STAMP</button></div>
        <div class="status-row"><span class="status-lbl">In Service</span><button class="stamp-btn" data-unit="E2" data-status="InService" onclick="stamp(this)">STAMP</button></div>
        <div class="status-row"><span class="status-lbl">In Station</span><button class="stamp-btn" data-unit="E2" data-status="InStation" onclick="stamp(this)">STAMP</button></div>
      </div>
      <div class="unit-col">
        <div class="unit-id-row"><span class="unit-id-label">E3</span></div>
        <div class="status-row"><span class="status-lbl">Enroute</span>   <button class="stamp-btn" data-unit="E3" data-status="Enroute"   onclick="stamp(this)">STAMP</button></div>
        <div class="status-row"><span class="status-lbl">Arrived</span>   <button class="stamp-btn" data-unit="E3" data-status="Arrived"   onclick="stamp(this)">STAMP</button></div>
        <div class="status-row"><span class="status-lbl">In Service</span><button class="stamp-btn" data-unit="E3" data-status="InService" onclick="stamp(this)">STAMP</button></div>
        <div class="status-row"><span class="status-lbl">In Station</span><button class="stamp-btn" data-unit="E3" data-status="InStation" onclick="stamp(this)">STAMP</button></div>
      </div>
      <div class="unit-col">
        <div class="unit-id-row"><span class="unit-id-label">E4</span></div>
        <div class="status-row"><span class="status-lbl">Enroute</span>   <button class="stamp-btn" data-unit="E4"  data-status="Enroute"   onclick="stamp(this)">STAMP</button></div>
        <div class="status-row"><span class="status-lbl">Arrived</span>   <button class="stamp-btn" data-unit="E4"  data-status="Arrived"   onclick="stamp(this)">STAMP</button></div>
        <div class="status-row"><span class="status-lbl">In Service</span><button class="stamp-btn" data-unit="E4"  data-status="InService" onclick="stamp(this)">STAMP</button></div>
        <div class="status-row"><span class="status-lbl">In Station</span><button class="stamp-btn" data-unit="E4"  data-status="InStation" onclick="stamp(this)">STAMP</button></div>
      </div>
    </div>
  </div>

  <!-- Ambulances: A19, A22 | Nurse | Notifications -->
  <div class="units-section">
    <div class="sub-hdr">Ambulances / Nurse / Notifications</div>
    <div class="amb-nurse-grid">

      <!-- A1 -->
      <div class="unit-col">
        <div class="unit-id-row"><span class="unit-id-label">A1</span></div>
        <div class="status-row"><span class="status-lbl">Enroute</span>          <button class="stamp-btn" data-unit="A1" data-status="Enroute"        onclick="stamp(this)">STAMP</button></div>
        <div class="status-row"><span class="status-lbl">Arrived</span>          <button class="stamp-btn" data-unit="A1" data-status="Arrived"        onclick="stamp(this)">STAMP</button></div>
        <div class="status-row"><span class="status-lbl">Patient Contact</span>  <button class="stamp-btn" data-unit="A1" data-status="PatientContact" onclick="stamp(this)">STAMP</button></div>
        <div class="status-row"><span class="status-lbl">Transport</span>        <button class="stamp-btn" data-unit="A1" data-status="Transport"      onclick="stamp(this)">STAMP</button></div>
        <div class="status-row"><span class="status-lbl">At Hospital</span>      <button class="stamp-btn" data-unit="A1" data-status="AtHospital"     onclick="stamp(this)">STAMP</button></div>
        <div class="status-row"><span class="status-lbl">Transfer of Care</span> <button class="stamp-btn" data-unit="A1" data-status="TransferOfCare" onclick="stamp(this)">STAMP</button></div>
        <div class="status-row"><span class="status-lbl">In Service</span>       <button class="stamp-btn" data-unit="A1" data-status="InService"      onclick="stamp(this)">STAMP</button></div>
        <div class="status-row"><span class="status-lbl">In Station</span>       <button class="stamp-btn" data-unit="A1" data-status="InStation"      onclick="stamp(this)">STAMP</button></div>
      </div>

      <!-- A2 -->
      <div class="unit-col">
        <div class="unit-id-row"><span class="unit-id-label">A2</span></div>
        <div class="status-row"><span class="status-lbl">Enroute</span>          <button class="stamp-btn" data-unit="A2" data-status="Enroute"        onclick="stamp(this)">STAMP</button></div>
        <div class="status-row"><span class="status-lbl">Arrived</span>          <button class="stamp-btn" data-unit="A2" data-status="Arrived"        onclick="stamp(this)">STAMP</button></div>
        <div class="status-row"><span class="status-lbl">Patient Contact</span>  <button class="stamp-btn" data-unit="A2" data-status="PatientContact" onclick="stamp(this)">STAMP</button></div>
        <div class="status-row"><span class="status-lbl">Transport</span>        <button class="stamp-btn" data-unit="A2" data-status="Transport"      onclick="stamp(this)">STAMP</button></div>
        <div class="status-row"><span class="status-lbl">At Hospital</span>      <button class="stamp-btn" data-unit="A2" data-status="AtHospital"     onclick="stamp(this)">STAMP</button></div>
        <div class="status-row"><span class="status-lbl">Transfer of Care</span> <button class="stamp-btn" data-unit="A2" data-status="TransferOfCare" onclick="stamp(this)">STAMP</button></div>
        <div class="status-row"><span class="status-lbl">In Service</span>       <button class="stamp-btn" data-unit="A2" data-status="InService"      onclick="stamp(this)">STAMP</button></div>
        <div class="status-row"><span class="status-lbl">In Station</span>       <button class="stamp-btn" data-unit="A2" data-status="InStation"      onclick="stamp(this)">STAMP</button></div>
      </div>

      <!-- Nurse (single) -->
      <div class="unit-col">
        <div class="unit-id-row"><span class="unit-id-label">Nurse</span></div>
        <div class="status-row"><span class="status-lbl">1st Page</span>  <button class="stamp-btn" data-unit="Nurse" data-status="1stPage"    onclick="stamp(this)">STAMP</button></div>
        <div class="status-row"><span class="status-lbl">2nd Page</span>  <button class="stamp-btn" data-unit="Nurse" data-status="2ndPage"    onclick="stamp(this)">STAMP</button></div>
        <div class="status-row"><span class="status-lbl">Call Back</span> <button class="stamp-btn" data-unit="Nurse" data-status="CallBack"   onclick="stamp(this)">STAMP</button></div>
        <div class="status-row"><span class="status-lbl">At Hospital</span><button class="stamp-btn" data-unit="Nurse" data-status="AtHospital" onclick="stamp(this)">STAMP</button></div>
      </div>

      <!-- Notifications -->
      <div class="unit-col" style="border-right:none;">
        <div class="unit-id-row" style="background:var(--bg-gray);"><span class="unit-id-label">Notifications</span></div>
        <div class="status-row"><span class="status-lbl">Security</span><button class="stamp-btn" data-unit="Notif" data-status="Security" onclick="stamp(this)">STAMP</button></div>
        <div class="status-row"><span class="status-lbl">Safety</span>  <button class="stamp-btn" data-unit="Notif" data-status="Safety"   onclick="stamp(this)">STAMP</button></div>
      </div>

    </div>
  </div>

  <!-- Additional Units: U1, U2, U3, U4 -->
  <div class="units-section">
    <div class="sub-hdr">Additional Units</div>
    <div class="unit-grid">
      <div class="unit-col">
        <div class="unit-id-row"><span class="unit-id-label">U1</span></div>
        <div class="status-row"><span class="status-lbl">Enroute</span>   <button class="stamp-btn" data-unit="U1"   data-status="Enroute"   onclick="stamp(this)">STAMP</button></div>
        <div class="status-row"><span class="status-lbl">Arrived</span>   <button class="stamp-btn" data-unit="U1"   data-status="Arrived"   onclick="stamp(this)">STAMP</button></div>
        <div class="status-row"><span class="status-lbl">In Service</span><button class="stamp-btn" data-unit="U1"   data-status="InService" onclick="stamp(this)">STAMP</button></div>
        <div class="status-row"><span class="status-lbl">In Station</span><button class="stamp-btn" data-unit="U1"   data-status="InStation" onclick="stamp(this)">STAMP</button></div>
      </div>
      <div class="unit-col">
        <div class="unit-id-row"><span class="unit-id-label">U2</span></div>
        <div class="status-row"><span class="status-lbl">Enroute</span>   <button class="stamp-btn" data-unit="U2"  data-status="Enroute"   onclick="stamp(this)">STAMP</button></div>
        <div class="status-row"><span class="status-lbl">Arrived</span>   <button class="stamp-btn" data-unit="U2"  data-status="Arrived"   onclick="stamp(this)">STAMP</button></div>
        <div class="status-row"><span class="status-lbl">In Service</span><button class="stamp-btn" data-unit="U2"  data-status="InService" onclick="stamp(this)">STAMP</button></div>
        <div class="status-row"><span class="status-lbl">In Station</span><button class="stamp-btn" data-unit="U2"  data-status="InStation" onclick="stamp(this)">STAMP</button></div>
      </div>
      <div class="unit-col">
        <div class="unit-id-row"><span class="unit-id-label">U3</span></div>
        <div class="status-row"><span class="status-lbl">Enroute</span>   <button class="stamp-btn" data-unit="U3"  data-status="Enroute"   onclick="stamp(this)">STAMP</button></div>
        <div class="status-row"><span class="status-lbl">Arrived</span>   <button class="stamp-btn" data-unit="U3"  data-status="Arrived"   onclick="stamp(this)">STAMP</button></div>
        <div class="status-row"><span class="status-lbl">In Service</span><button class="stamp-btn" data-unit="U3"  data-status="InService" onclick="stamp(this)">STAMP</button></div>
        <div class="status-row"><span class="status-lbl">In Station</span><button class="stamp-btn" data-unit="U3"  data-status="InStation" onclick="stamp(this)">STAMP</button></div>
      </div>
      <div class="unit-col">
        <div class="unit-id-row"><span class="unit-id-label">U4</span></div>
        <div class="status-row"><span class="status-lbl">Enroute</span>   <button class="stamp-btn" data-unit="U4" data-status="Enroute"   onclick="stamp(this)">STAMP</button></div>
        <div class="status-row"><span class="status-lbl">Arrived</span>   <button class="stamp-btn" data-unit="U4" data-status="Arrived"   onclick="stamp(this)">STAMP</button></div>
        <div class="status-row"><span class="status-lbl">In Service</span><button class="stamp-btn" data-unit="U4" data-status="InService" onclick="stamp(this)">STAMP</button></div>
        <div class="status-row"><span class="status-lbl">In Station</span><button class="stamp-btn" data-unit="U4" data-status="InStation" onclick="stamp(this)">STAMP</button></div>
      </div>
    </div>
  </div>

  <!-- META BAR -->
  <div class="meta-bar">
    <div class="meta-field"><span class="meta-lbl">Date:</span>   <input class="meta-input" id="metaDateMirror"    readonly></div>
    <div class="meta-field"><span class="meta-lbl">Shift:</span>  <input class="meta-input" id="metaShiftMirror"   readonly></div>
    <div class="meta-field"><span class="meta-lbl">Station:</span><input class="meta-input" id="metaStationMirror" readonly></div>
    <div class="meta-field"><span class="meta-lbl">Elapsed:</span><div class="elapsed-disp" id="elapsedDisp">--:--:--</div></div>
  </div>

  <!-- REMARKS LOG -->
  <div class="log-section">
    <div class="sec-hdr">‚ñ∂ INCIDENT REMARKS LOG</div>
    <div class="log-col-hdrs">
      <div class="log-col-h">Time</div>
      <div class="log-col-h">Remarks <span style="font-weight:400;font-size:0.65em;opacity:0.7;">(click to edit)</span></div>
      <div class="log-col-h">Del</div>
    </div>

    <!-- New entry row -->
    <div class="entry-row">
      <div class="etime-cell">
        <div class="etime-disp" id="etimeDisp">--:--:--</div>
        <button class="btn-now" onclick="refreshTime()">‚è± NOW</button>
      </div>
      <div class="etext-cell">
        <input class="etext-input" id="entryText" placeholder="Type remark ‚Äî Enter or LOG to stamp &amp; record...">
      </div>
      <div class="eact-cell">
        <button class="btn-log" onclick="addEntry()">LOG</button>
        <div class="hotkey">‚Üµ Enter</div>
      </div>
    </div>

    <div id="logBody">
      <div class="log-empty" id="emptyState">NO ENTRIES ‚Äî BEGIN RECORDING ACTIVITY</div>
    </div>
  </div>

  <!-- FOOTER -->
  <div class="footer">
    <div class="footer-stats">
      ENTRIES: <b id="entryCount">0</b> &nbsp;¬∑&nbsp;
      INC: <b id="statInc">‚Äî</b> &nbsp;¬∑&nbsp;
      ALARM: <b id="statAlarm">‚Äî</b> &nbsp;¬∑&nbsp;
      DISPATCH: <b id="statDispatch">‚Äî</b>
    </div>
    <div class="footer-btns">
      <button class="btn-clear"  onclick="clearAll()">CLEAR ALL</button>
      <button class="btn-export" onclick="exportToExcel()">‚¨á EXPORT TO EXCEL</button>
    </div>
  </div>

</div>
<div class="toast" id="toast"></div>

<script>
// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ
let entries = [], entryCounter = 0, incidentStart = null, stamps = {};
let alarmTime = '', dispatchTime = '';

// Auto-fill today's date
const _now = new Date();
const _dateStr = ((_now.getMonth()+1)+'').padStart(2,'0')+'/'+(''+_now.getDate()).padStart(2,'0')+'/'+_now.getFullYear();
document.getElementById('metaDate').value = _dateStr;
syncMirrors();

// Sync mirror fields (read-only display below units)
function syncMirrors() {
  document.getElementById('metaDateMirror').value    = document.getElementById('metaDate').value;
  document.getElementById('metaShiftMirror').value   = document.getElementById('metaShift').value;
  document.getElementById('metaStationMirror').value = document.getElementById('metaStation').value;
}
['metaDate','metaShift','metaStation'].forEach(id =>
  document.getElementById(id).addEventListener('input', syncMirrors)
);

// ‚îÄ‚îÄ CLOCK ‚îÄ‚îÄ
function ts() {
  const n = new Date();
  return [n.getHours(),n.getMinutes(),n.getSeconds()].map(v=>(''+v).padStart(2,'0')).join(':');
}

function updateClock() {
  const n = new Date();
  document.getElementById('liveClock').textContent = ts();
  const days=['SUN','MON','TUE','WED','THU','FRI','SAT'];
  const months=['JAN','FEB','MAR','APR','MAY','JUN','JUL','AUG','SEP','OCT','NOV','DEC'];
  document.getElementById('liveDate').textContent =
    `${days[n.getDay()]} ${months[n.getMonth()]} ${n.getDate()}, ${n.getFullYear()}`;
  if (incidentStart) {
    const d = Math.floor((n - incidentStart) / 1000);
    const h=Math.floor(d/3600), m=Math.floor((d%3600)/60), s=d%60;
    document.getElementById('elapsedDisp').textContent =
      [h,m,s].map(v=>(''+v).padStart(2,'0')).join(':');
  }
}
setInterval(updateClock, 1000);
updateClock();

// ‚îÄ‚îÄ SET ALARM / DISPATCH ‚îÄ‚îÄ
function setTime(which) {
  const t = ts();
  if (which === 'alarm') {
    alarmTime = t;
    document.getElementById('alarmDisp').textContent = t;
    showToast('ALARM TIME SET: ' + t);
  } else {
    dispatchTime = t;
    document.getElementById('dispatchDisp').textContent = t;
    if (!incidentStart) incidentStart = new Date();
    showToast('DISPATCH TIME SET: ' + t);
  }
  updateStats();
}

// ‚îÄ‚îÄ UNIT STAMPS ‚îÄ‚îÄ
// Human-readable status labels for the log
const STATUS_LABELS = {
  Enroute: 'Enroute', Arrived: 'Arrived', InService: 'In Service', InStation: 'In Station',
  PatientContact: 'Patient Contact', Transport: 'Transport', AtHospital: 'At Hospital',
  TransferOfCare: 'Transfer of Care', '1stPage': '1st Page', '2ndPage': '2nd Page',
  CallBack: 'Call Back', Security: 'Security', Safety: 'Safety'
};

function stamp(btn) {
  const unit   = btn.dataset.unit;
  const status = btn.dataset.status;
  const t = ts();
  stamps[unit + '_' + status] = t;
  btn.textContent = t;
  btn.classList.add('stamped');
  btn.title = 'Click to re-stamp';
  if (!incidentStart) incidentStart = new Date();
  showToast(`‚úì ${unit} ‚Äî ${status}: ${t}`);

  // Auto-log this stamp as a remark entry
  entryCounter++;
  const label = STATUS_LABELS[status] || status;
  const e = { num: entryCounter, time: t, text: `[${unit}] ${label}`, auto: true };
  entries.push(e);
  renderRow(e);
  updateStats();
}

// ‚îÄ‚îÄ ENTRY TIME ‚îÄ‚îÄ
function refreshTime() {
  document.getElementById('etimeDisp').textContent = ts();
  document.getElementById('entryText').focus();
}

// Auto-show time when user clicks into the entry box
document.getElementById('entryText').addEventListener('focus', () => {
  if (document.getElementById('etimeDisp').textContent === '--:--:--') refreshTime();
});

// Keep entry time ticking once set
setInterval(() => {
  const el = document.getElementById('etimeDisp');
  if (el.textContent !== '--:--:--') el.textContent = ts();
}, 1000);

// ‚îÄ‚îÄ ADD ENTRY ‚îÄ‚îÄ
function addEntry() {
  const text = document.getElementById('entryText').value.trim();
  if (!text) { showToast('‚ö† ENTER REMARK TEXT', 'warn'); return; }
  const t = ts();
  if (!incidentStart) incidentStart = new Date();
  entryCounter++;
  const e = { num: entryCounter, time: t, text };
  entries.push(e);
  renderRow(e);
  document.getElementById('entryText').value = '';
  document.getElementById('etimeDisp').textContent = '--:--:--';
  document.getElementById('entryText').focus();
  updateStats();
  showToast(`‚úì LOGGED [${t}] #${entryCounter}`);
}

// ‚îÄ‚îÄ RENDER ROW ‚Äî with editable textarea for remark ‚îÄ‚îÄ
function renderRow(e) {
  document.getElementById('emptyState')?.remove();
  const row = document.createElement('div');
  row.className = 'log-row' + (e.auto ? ' auto-stamp' : '');
  row.id = 'row-' + e.num;

  const timeCell = document.createElement('div');
  timeCell.className = 'log-time';
  timeCell.textContent = e.time;

  const remarkInput = document.createElement('textarea');
  remarkInput.className = 'log-remark-input';
  remarkInput.value = e.text;
  remarkInput.rows = 1;
  remarkInput.spellcheck = true;
  // Auto-resize on input
  remarkInput.addEventListener('input', () => {
    remarkInput.style.height = 'auto';
    remarkInput.style.height = remarkInput.scrollHeight + 'px';
    // Update the entry in state
    e.text = remarkInput.value;
  });
  // Prevent Enter from adding new lines (use Shift+Enter for newline)
  remarkInput.addEventListener('keydown', ev => {
    if (ev.key === 'Enter' && !ev.shiftKey) {
      ev.preventDefault();
      document.getElementById('entryText').focus();
    }
  });

  const actCell = document.createElement('div');
  actCell.className = 'log-acts';
  actCell.innerHTML = `<button class="btn-del" onclick="delEntry(${e.num})" title="Delete">‚úï</button>`;

  row.appendChild(timeCell);
  row.appendChild(remarkInput);
  row.appendChild(actCell);
  const body = document.getElementById('logBody');
  body.appendChild(row);
  // Scroll new entry into view
  row.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

function delEntry(num) {
  if (!confirm('Delete this entry?')) return;
  entries = entries.filter(e => e.num !== num);
  document.getElementById('row-' + num)?.remove();
  updateStats();
  if (!entries.length)
    document.getElementById('logBody').innerHTML =
      '<div class="log-empty" id="emptyState">NO ENTRIES ‚Äî BEGIN RECORDING ACTIVITY</div>';
}

function updateStats() {
  document.getElementById('entryCount').textContent   = entries.length;
  document.getElementById('statInc').textContent      = document.getElementById('incidentNum').value || '‚Äî';
  document.getElementById('statAlarm').textContent    = alarmTime || '‚Äî';
  document.getElementById('statDispatch').textContent = dispatchTime || '‚Äî';
}

// ‚îÄ‚îÄ CLEAR ALL ‚îÄ‚îÄ
function clearAll() {
  if (!confirm('Clear all data? This cannot be undone.')) return;
  entries = []; entryCounter = 0; incidentStart = null; stamps = {};
  alarmTime = ''; dispatchTime = '';
  document.getElementById('alarmDisp').textContent    = '--:--:--';
  document.getElementById('dispatchDisp').textContent = '--:--:--';
  document.getElementById('elapsedDisp').textContent  = '--:--:--';
  document.querySelectorAll('.stamp-btn').forEach(b => {
    b.textContent = 'STAMP'; b.classList.remove('stamped'); b.title = '';
  });
  document.getElementById('logBody').innerHTML =
    '<div class="log-empty" id="emptyState">NO ENTRIES ‚Äî BEGIN RECORDING ACTIVITY</div>';
  updateStats();
  showToast('ALL DATA CLEARED');
}

// ‚îÄ‚îÄ EXPORT TO EXCEL ‚îÄ‚îÄ
function exportToExcel() {
  const incNum    = document.getElementById('incidentNum').value;
  const incLoc    = document.getElementById('incidentLoc').value;
  const incType   = document.getElementById('incidentType').value;
  const aroName   = document.getElementById('aroName').value;
  const date      = document.getElementById('metaDate').value;
  const shift     = document.getElementById('metaShift').value;
  const station   = document.getElementById('metaStation').value;
  const elapsed   = document.getElementById('elapsedDisp').textContent;

  const rows = [];

  // Title
  rows.push(['INCIDENT REPORT','','','','','','','','','','']);
  rows.push(['']);
  rows.push(['Incident Number:','',incNum,'','','','Incident Location:','',incLoc,'','']);
  rows.push(['Type of Incident:','',incType,'','','','ARO:','',aroName,'','']);
  rows.push(['Alarm Time:','',alarmTime,'','Dispatch Time:','',dispatchTime,'Date:',date,'Shift / Station:',`${shift} / ${station}`]);
  rows.push(['']);

  // Unit section builder
  function unitSection(label, unitList, statusList) {
    rows.push([label,'','','','','','','','','','']);
    // Header: unit IDs across cols
    const hdr = [];
    unitList.forEach(u => { hdr.push(u); hdr.push('TIME'); hdr.push(''); });
    rows.push(hdr.slice(0,11));
    statusList.forEach(([lbl, suf]) => {
      const r = [];
      unitList.forEach(u => {
        r.push(lbl);
        r.push(stamps[u + '_' + suf] || '');
        r.push('');
      });
      rows.push(r.slice(0,11));
    });
    rows.push(['']);
  }

  unitSection('ENGINES / TRUCKS / BATTALION',
    ['E1','E2','E3','E4'],
    [['Enroute','Enroute'],['Arrived','Arrived'],['In Service','InService'],['In Station','InStation']]
  );

  // Ambulances: 2 units side by side with Nurse + Notifications
  rows.push(['AMBULANCES / NURSE / NOTIFICATIONS','','','','','','','','','','']);
  rows.push(['A1','TIME','','A2','TIME','','Nurse','TIME','','Notifications','TIME']);
  const ambSt=[['Enroute','Enroute'],['Arrived','Arrived'],['Patient Contact','PatientContact'],
               ['Transport','Transport'],['At Hospital','AtHospital'],['Transfer of Care','TransferOfCare'],
               ['In Service','InService'],['In Station','InStation']];
  const nurseSt=[['1st Page','1stPage'],['2nd Page','2ndPage'],['Call Back','CallBack'],['At Hospital','AtHospital']];
  const notifSt=[['Security','Security'],['Safety','Safety']];
  const maxR = Math.max(ambSt.length, nurseSt.length, notifSt.length);
  for(let i=0;i<maxR;i++){
    const r=[];
    if(i<ambSt.length){r.push(ambSt[i][0]);r.push(stamps['A1_'+ambSt[i][1]]||'');r.push('');}else{r.push('');r.push('');r.push('');}
    if(i<ambSt.length){r.push(ambSt[i][0]);r.push(stamps['A2_'+ambSt[i][1]]||'');r.push('');}else{r.push('');r.push('');r.push('');}
    if(i<nurseSt.length){r.push(nurseSt[i][0]);r.push(stamps['Nurse_'+nurseSt[i][1]]||'');r.push('');}else{r.push('');r.push('');r.push('');}
    if(i<notifSt.length){r.push(notifSt[i][0]);r.push(stamps['Notif_'+notifSt[i][1]]||'');}else{r.push('');r.push('');}
    rows.push(r.slice(0,11));
  }
  rows.push(['']);

  unitSection('ADDITIONAL UNITS',
    ['U1','U2','U3','U4'],
    [['Enroute','Enroute'],['Arrived','Arrived'],['In Service','InService'],['In Station','InStation']]
  );

  // Meta
  rows.push(['DATE:',date,'','SHIFT:',shift,'','STATION:',station,'','ELAPSED:',elapsed]);
  rows.push(['ARO & Type of Incident:',incType,'','','','','','','','','']);
  rows.push(['']);

  // Remarks log
  rows.push(['TIME','REMARKS','','','','','','','','','']);
  if (entries.length) {
    entries.forEach(e => rows.push([e.time, e.text,'','','','','','','','','']));
  } else {
    for(let i=0;i<10;i++) rows.push(['','','','','','','','','','','']);
  }

  const sheet = XLSX.utils.aoa_to_sheet(rows);
  sheet['!cols'] = [
    {wch:20},{wch:12},{wch:2},
    {wch:20},{wch:12},{wch:2},
    {wch:20},{wch:12},{wch:2},
    {wch:20},{wch:12}
  ];
  sheet['!merges'] = [
    {s:{r:0,c:0},e:{r:0,c:10}},
    {s:{r:2,c:2},e:{r:2,c:5}},
    {s:{r:2,c:8},e:{r:2,c:9}},
    {s:{r:3,c:2},e:{r:3,c:10}},
  ];

  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, sheet, 'Incident Log');
  const fname = `IncidentReport_${(incNum||'export').replace(/[^a-zA-Z0-9]/g,'_')}_${(date||'').replace(/\//g,'-')}.xlsx`;
  XLSX.writeFile(wb, fname);
  showToast('‚úì EXPORTED: ' + fname);
}

// ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ
function showToast(msg, type) {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.className = 'toast' + (type==='warn' ? ' warn' : '') + ' show';
  clearTimeout(window._tt);
  window._tt = setTimeout(() => el.classList.remove('show'), 3000);
}

// ‚îÄ‚îÄ KEYBOARD ‚îÄ‚îÄ
document.getElementById('entryText').addEventListener('keydown', e => {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); addEntry(); }
});
document.addEventListener('keydown', e => {
  if (e.key === 'F2') {
    e.preventDefault();
    const f = document.getElementById('entryText');
    const p = f.selectionStart;
    const t = `[${ts()}]`;
    f.value = f.value.slice(0,p) + t + f.value.slice(p);
    f.selectionStart = f.selectionEnd = p + t.length;
    f.focus();
    showToast('TIMESTAMP INSERTED');
  }
});
</script>
</body>
</html>
